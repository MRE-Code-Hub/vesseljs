<html>
	<head>
		<title>Ship in Ocean</title>
		<script src="../build/vessel.js"></script>

		<script src="libs/three_r118.js"></script>
		<script src="libs/STLLoader.js"></script>
		<script src="libs/GLTFLoader.js"></script>

		<script src="snippets/Ship3D_v2.js"></script>

		<!-- Upgrading to WaterShader2.js will remove the dependency
	on Mirror.js as well as open up possibilities for visualizing approximate water flows around vessels. -->
		<!-- <script src="libs/Mirror.js"></script>-->
		<!-- <script src="libs/WaterShader.js"></script> -->
		<script src="libs/Water.js"></script>

		<!-- Bootstrap Core CSS -->
		<link href="examples/libs/bootstrap.min.css" rel="stylesheet">

		<!-- jQuery Version 1.11.1 -->
		<script src="examples/libs/jquery.js"></script>

		<script src="libs/OrbitControls.js"></script>
		<script src="libs/dat.gui.min.js"></script>
		<script src="libs/skybox_from_examples_r118.js"></script>
		<script src="libs/browse_files_Elias_Hasle.js"></script>

		<script src="snippets/Patch_interpolation.js"></script>
		<script src="snippets/renderRayCaster.js"></script>
		<!--<script src="Moving_bodies_Elias_Hasle.js"></script>-->
		<script src="snippets/Playback.js"></script>
		<!-- <script src="snippets/Configurable_ocean.js"></script> -->
		<script src="snippets/Configurable_ocean2.js"></script>
		<!--<script src="keyboard_arrow_input_Elias_Hasle.js"></script>-->
	
		<script src="snippets/FreeBody.js"></script>
		<script src="libs/numeric-1.2.6.min.js"></script>
	</head>

	<style>
		table {
			margin-top: 15px;
			margin-bottom: 10px;
			border-radius: 10%;			
		}

		table,
		td {
			color: #fff;
			background-color: #000;			
		}

		td {
			border: 1px solid #fff;
			border-radius: 20%;	
			width: 100px;
		}

		tr {
			background-color: #000;			
		}

		#button {
			position: fixed;
			bottom: 16px;
			right: 16px;

			padding: 12px;
			border-radius: 50%;
			margin-bottom: 0px;

			background-color: #fff;
			opacity: 0.9;
			z-index: 999;

			box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
		}


		#panel-number {
			position: fixed;
			top: 16px;
			left: 16px;

			text-align: center;

			/* padding: 5px; */
			/* border-radius: 10%; */
			/* margin-bottom: 0px; */

			background-color: #fff;
			/* opacity: 0.9; */
			z-index: 999;

			/* box-shadow: 0 0 4px rgba(0, 0, 0, 0.15); */
		}

		.close {
			position: absolute;
			right: 10px;
			top: 5px;
			width: 16px;
			height: 22px;
			opacity: 0.6;
		}
		.close:hover {
			opacity: 1;
			cursor: pointer;
		}
		.close:before,
		.close:after {
			position: absolute;
			left: 10px;
			content: " ";
			height: 10px;
			width: 2px;
			background-color: #fff;
		}
		.close:before {
			transform: rotate(45deg);
		}
		.close:after {
			transform: rotate(-45deg);
		}

		/* LOADER */
		#loader-wrapper {
			width: 100%;
			height: 100%;
			text-align: center;
			position: absolute;
			top: 0;
			left: 0;
			background-color: #00509e;
			color: #fff;
			font-family: Helvetica;
			z-index: 105;
		}

		.loader {
			display: inline-block;
			width: 50px;
			height: 50px;
			position: relative;
			margin-top: 17%;
			border-radius: 50%;
			vertical-align: middle;
		}
		.loader,
		.loader:before,
		.loader:after {
			animation: 1s infinite ease-in-out;
		}
		.loader:before,
		.loader:after {
			width: 100%;
			height: 100%;
			border-radius: 50%;
			position: absolute;
			top: 0;
			left: 0;
		}

		.loader-white {
			background-color: #fff;
		}

		.loader-1 {
			animation-name: loader1;
		}
		@-webkit-keyframes loader1 {
			from {
				transform: scale(0);
				opacity: 1;
			}
			to {
				transform: scale(1);
				opacity: 0;
			}
		}
	</style>

	<body>

		<div id="loader-wrapper">
			<div class="loader loader-white loader-1"></div>
			<div><h1 style="font-style: italic">Loading...</h1></div>
		</div>

		<a id="button" target="_blank" href="https://github.com/ferrari212/vesseljs/blob/master/examples/Gunnerus_Complete_Example.html" title="View source code for animation / cloth on GitHub" style="">
			<img src="..\examples\images\code-24px.svg" />
		</a>

		<table id="panel-number">
			<tr valign="top">
				<td>
					<p style="font-size: 10px">Speed</p>
					<h2>10</h2>
					<p style="font-size: 10px">m/s</p>			
				</td>
				<td>
					<p style="font-size: 10px">Displays here the stats</p>
					<h2>10</h2>
					<p style="font-size: 10px">m/s</p>
				</td>
			</tr>			
		</table>

		<script>
			"use strict"

			// JavaScript for adding loader page
			window.addEventListener("load", function () {
				var fadeTarget = document.getElementById("loader-wrapper")
				var fadeEffect = setInterval(function () {
					if (!fadeTarget.style.opacity) {
						fadeTarget.style.opacity = 1
					}

					if (fadeTarget.style.opacity > 0) {
						fadeTarget.style.opacity -= 0.05
					} else {
						clearInterval(fadeEffect)
						fadeTarget.remove()
					}
				}, 50)
			})

			document.addEventListener("keydown", onDocumentKeyDown, false)
			function onDocumentKeyDown(event) {
				var keyCode = event.which;
				// console.log(keyCode)
				if (keyCode == 87) {
					// cube.position.y += ySpeed;
					// Just a preliminary, in real case the ship moves according to the
					// variation in the global reference system
					console.log('Ship power goes up')
					zUpCont.getObjectByName("ModelGLTF").position.x += .5
				} else if (keyCode == 83) {
					console.log('Ship power goes down')
					zUpCont.getObjectByName("ModelGLTF").position.x -= .5
				} else if (keyCode == 65) {
					zUpCont.getObjectByName("ModelGLTF").position.y += .5
				} else if (keyCode == 68) {
					console.log('Ship power goes right')
					zUpCont.getObjectByName("ModelGLTF").position.y -= .5
				}
			}

			//Globals
			var renderer, camera, controls, gui, stats
			var scene, zUpCont, playback, bodies, ocean, ship3D, shipGLTF
			var Teste
			var scale, modelStyle

			;(function main() {
				//Renderer setup
				//document.body.style = "overflow: hidden;";
				document.body.style.overflow = "hidden"
				var container = document.createElement("div")
				container.id = "SimulationWindow"
				//container.style = "position: absolute; top: 0; left: 0;"
				Object.assign(container.style, {
					position: "absolute",
					top: 0,
					left: 0,
					width: "100vw",
					height: "100vh"
				})
				document.body.appendChild(container)
				renderer = new THREE.WebGLRenderer({ antialias: true })
				//renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.setClearColor(0xa9cce3)
				container.appendChild(renderer.domElement)

				playback = new Playback({ parentGUI: gui })

				//Scene setup:
				scene = new THREE.Scene()
				let sun = new THREE.DirectionalLight(0xffffff, 2)
				sun.position.set(-512, 246, 128)
				scene.add(sun)

				//Ocean size
				let oSize = 2048

				//Use Z up from now on:
				THREE.Object3D.DefaultUp.set(0, 0, 1)
				zUpCont = new THREE.Group()
				// This rotation must be deleted in order to garantee the real coordinate
				// zUpCont.rotation.x = -0.5 * Math.PI;
				scene.add(zUpCont)

				var skybox = new Skybox(oSize)
				skybox.name = "Skybox"
				scene.add(skybox)

				//Camera setup
				camera = new THREE.PerspectiveCamera(26, window.innerWidth / window.innerHeight, 1, 1000000)

				let onResize = function () {
					let w = container.clientWidth
					let h = container.clientHeight
					renderer.setSize(w, h)
					camera.aspect = w / h
					camera.updateProjectionMatrix()
				}

				camera.up.set(0, 1, 0)

				window.addEventListener("resize", onResize, false)
				onResize()
				camera.position.set(-oSize * 0.03, oSize * 0.01, 0)
				console.log(zUpCont.position)
				

				controls = new THREE.OrbitControls(camera, renderer.domElement)
				controls.enablePan = false

				// zUpCont.add(new THREE.AxesHelper(1000))
				zUpCont.add(new THREE.HemisphereLight(0xccccff, 0x666688, 1))

				ocean = new Ocean({
					parentGUI: gui,
					sunDir: sun.position.clone().normalize(),
					size: oSize,
					segments: 127
				})

				// playback.add(ocean)
				ocean.name = "Ocean"
				scene.add(ocean)
				scene.rotation.x = -Math.PI / 2

				// import binary glTF file
				var boatPath = "specs/GLTF_files/Gunnerus.glb"
				var loaderGLTF = new THREE.GLTFLoader()
				loaderGLTF.load(boatPath, async gltf => {
					shipGLTF = gltf.scene
					shipGLTF.rotation.x = Math.PI / 2
					shipGLTF.rotation.y = -Math.PI / 2
					shipGLTF.position.set(-1, 0, 0)
					shipGLTF.name = "ModelGLTF"

					if (shipGLTF.material) {
						shipGLTF.material.side = THREE.DoubleSide
					}

					await zUpCont.add(shipGLTF)
				})

				// Recursive function to find element and delete
				function toggleElement(element, name) {
					if (element.children.lenght == 0) {
						return
					}

					element.children.forEach(child => {
						if (child.group == name) {
							// Verify if it is visible trought the masks layers
							child.layers.mask ? child.layers.disable(0) : child.layers.enable(0)
						}

						toggleElement(child, name)
					})
				}

				var m = 10
				var I = [[10, 10, 10], [10, 10, 10], [10, 10, 10]]
				var D = [[10, 10, 10], [10, 10, 10], [10, 10, 10]]

				Teste = new ManouvringModel(m, I, D, Math.PI/2)
				var Teste2 = new FreeBody(m, 10)
				console.log(Teste)
				console.log(Teste2)

				// //GUI setup (comment out to remove gui)
				// gui = new dat.GUI()

				requestAnimationFrame(animate)
			})()

			function animate(millitime) {
				ocean.water.material.uniforms.time.value += 1 / 60
				camera.lookAt(20, 10, 0)

				renderer.render(scene, camera)
				requestAnimationFrame(animate)
			}
		</script>
	</body>
</html>
